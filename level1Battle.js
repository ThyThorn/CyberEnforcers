var gameLevel1 = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
];

var background;
var backgroundVir;
var moveButton;
var battleTheme1;
var kaito;
var virus;
var scaleFactor = 16;
var kaitoObject;
var virusObject;
var playerTeam = new Array();
var enemyTeam = new Array();
var level1Width = 30; // Will be used to make copying code for the other levels easier,
var level1Height = 30; // since it will involve only changing variable names and not hardcoded values.
var xSelected;
var ySelected;
var turnNumber = 1;
var shiftFactor = 16;

var level1Battle = function(game) {};
level1Battle.prototype = {
    preload: function() {
        game.load.atlas('atlas', 'phaser/myGame/assets/allSprites.png', 'phaser/myGame/assets/allSprites.json'); // Load the atlas.
        game.load.image('background', 'phaser/myGame/assets/level1.png');
        game.load.image('backgroundVir', 'phaser/myGame/assets/level1v.png');
        game.load.image('greenTile', 'phaser/myGame/assets/highlight.png');
        game.load.image('moveButton', 'phaser/myGame/assets/movefullicon.png');
        game.load.image('attackButton', 'phaser/myGame/assets/attackfullicon.png');
        game.load.audio('battleTheme1', 'phaser/myGame/bgm/Fighting is not an option.mp3');
    },

    create: function() {
        game.scale.setGameSize(960, 530);
        game.physics.startSystem(Phaser.Physics.ARCADE);
        background = game.add.sprite(0, 0, 'background');
        background.inputEnabled = true;
        background.events.onInputDown.add(chooseUnit, this);
        backgroundVir = game.add.sprite(game.world.width/2, 0, 'backgroundVir');
        moveButton = game.add.button(0, game.world.height - 50, 'moveButton', moveUnit, this);
        attackButton = game.add.button(155, game.world.height - 50, 'attackButton', attackUnit, this);
        battleTheme1 = game.add.audio('battleTheme1');
        battleTheme1.loop = true;
        battleTheme1.play();
        kaitoObject = new PhysUnit('Kaito', 20, 10, 5, 10, 'player', false, 19, 3, 'atlas', 'kaito01');
        game.add.existing(kaitoObject);
        kaitoObject1 = new PhysUnit('Kaito1', 20, 10, 5, 10, 'player', false, 14, 10, 'atlas', 'kaito01');
        game.add.existing(kaitoObject1);
        kaitoObject2 = new PhysUnit('Kaito2', 20, 10, 5, 10, 'player', false, 7, 23, 'atlas', 'kaito01');
        game.add.existing(kaitoObject2);
        virusObject = new PhysUnit('Virus', 25, 5, 5, 10, 'enemy', true, 15, 13, 'atlas', 'kenta01');
        game.add.existing(virusObject);
        virusObject1 = new PhysUnit('Virus', 25, 5, 5, 10, 'enemy', true, 20, 3, 'atlas', 'kenta01');
        game.add.existing(virusObject1);
        virusObject2 = new PhysUnit('Virus', 25, 5, 5, 10, 'enemy', true, 7, 24, 'atlas', 'kenta01');
        game.add.existing(virusObject2);
    },
    update: function(){
    }
}

var chosenSquare = false;
var movePressed = false;
var attackPressed = false;
var chosenX;
var chosenY;

function setInvisible() {
    for(var i = 0; i < playerTeam.length; i++) {
        playerTeam[i].pathTiles.visible = false;
    }
    for(var i = 0; i < enemyTeam.length; i++) {
        enemyTeam[i].pathTiles.visible = false;
    }
}

function disableButtons() {
    moveButton.input.enabled = false;
    attackButton.input.enabled = false;
}

function enableButtons() {
    moveButton.input.enabled = true;
    attackButton.input.enabled = true;
}

function moveUnit() {
    setInvisible();
    movePressed = true;
    attackPressed = false;
    disableButtons();
    console.log(movePressed);
}

function attackUnit() {
    setInvisible();
    attackPressed = true;
    movePressed = false;
    disableButtons();
    console.log('attackPressed: ' + attackPressed);
}

var newUnit;
var attacker;

function chooseUnit() {
    notEnemy:
    if(chosenSquare == false) {
        chosenX = Math.floor(game.input.mousePointer.x / 16);
        chosenY = Math.floor(game.input.mousePointer.y / 16);
        if(gameLevel1[chosenX][chosenY] instanceof PhysUnit) {
            setInvisible();
            gameLevel1[chosenX][chosenY].pathFinder();
            if(turnNumber % 2 == 1) {
                if(gameLevel1[chosenX][chosenY].team == 'player') {
                    if(movePressed == true) {
                        chosenSquare = true;
                        newUnit = gameLevel1[chosenX][chosenY];
                        return;
                    }
                    if(attackPressed == true) {
                        setInvisible();
                        chosenSquare = true;
                        attacker = gameLevel1[chosenX][chosenY];
                    }
                }
                else {
                    break notEnemy;
                }
            }
            else {
                if(gameLevel1[chosenX][chosenY].team == 'enemy') {
                    if(movePressed == true) {
                        chosenSquare = true;
                        newUnit = gameLevel1[chosenX][chosenY];
                        return;
                    }
                    if(attackPressed == true) {
                        setInvisible();
                        chosenSquare = true;
                        attacker = gameLevel1[chosenX][chosenY];
                    }
                }
                else {
                    break notEnemy;
                }
            }
        } 
        else {
            setInvisible();
            enableButtons();
        }
    }
    else if(movePressed == true) {
        chooseSquare();
    }
    else if(attackPressed == true) {
        attacker.checkEnemy();
    }
}

function chooseSquare() {
    xSelected = Math.floor(game.input.mousePointer.x / 16);
    ySelected = Math.floor(game.input.mousePointer.y / 16);
    if((xSelected >= 0 && xSelected < level1Width) && (ySelected >= 0 && ySelected < level1Height)) {
        if((gameLevel1[xSelected][ySelected] instanceof PhysUnit) == false) {
            if((chosenX > xSelected && game.math.difference(chosenX, xSelected) <= newUnit.leftMax && chosenY == ySelected))
            {
                newUnit.movesDone += game.math.difference(chosenX, xSelected);
                gameLevel1[xSelected][ySelected] = newUnit;
                newUnit.xPlace = xSelected;
                newUnit.yPlace = ySelected;
                gameLevel1[chosenX][chosenY] = 0;
                changeSprite(newUnit);
            }
            else if((xSelected > chosenX && game.math.difference(chosenX, xSelected) <= newUnit.rightMax && chosenY == ySelected)) {
                newUnit.movesDone += game.math.difference(chosenX, xSelected);
                gameLevel1[xSelected][ySelected] = newUnit;
                newUnit.xPlace = xSelected;
                newUnit.yPlace = ySelected;
                gameLevel1[chosenX][chosenY] = 0;
                changeSprite(newUnit);
            }
            else if((chosenY > ySelected && game.math.difference(chosenY, ySelected) <= newUnit.upMax && chosenX == xSelected)) {
                newUnit.movesDone += game.math.difference(chosenY, ySelected);
                gameLevel1[xSelected][ySelected] = newUnit;
                newUnit.xPlace = xSelected;
                newUnit.yPlace = ySelected;
                gameLevel1[chosenX][chosenY] = 0;
                changeSprite(newUnit);
            }
            else if((ySelected > chosenY && game.math.difference(chosenY, ySelected) <= newUnit.downMax && chosenX == xSelected)) {
                newUnit.movesDone += game.math.difference(chosenY, ySelected);
                gameLevel1[xSelected][ySelected] = newUnit;
                newUnit.xPlace = xSelected;
                newUnit.yPlace = ySelected;
                gameLevel1[chosenX][chosenY] = 0;
                changeSprite(newUnit);
            }
            movePressed = false;
            chosenSquare = false;
            setInvisible();
            enableButtons();
            return;
        }
    }
}

function changeSprite(change) {
    change.x = change.xPlace * 16;
    change.y = change.yPlace * 16;
    change.pathTiles.removeAll();
    change.enemyLeft = false;
    change.enemyRight = false;
    change.enemyUp = false;
    change.enemyDown = false;
    change.pathsFound = false;
    change.leftMax = 0;
    change.rightMax = 0;
    change.upMax = 0;
    change.downMax = 0;
    chosenSquare = false;
    movePressed = false;
    moveUnit();
    enableButtons();
    turnEnd(change.team);
}

function turnEnd (player) {        
    if(playerTeam.length == 0) {
        console.log("I lose!");
    }
    else if(enemyTeam.length == 0) {
        console.log("I win!");
    }
    counter = 0;
    if(player == 'player') {
        var counter = 0;
        for(var i = 0; i < playerTeam.length; i++) {
            if(playerTeam[i].movesDone == playerTeam[i].moveCount) {
                counter += 1;
            }
        }
        console.log('playerCounter: ' + counter); 
        if(counter == playerTeam.length) {
            for(var i = 0; i < playerTeam.length; i++) {
                playerTeam[i].movesDone = 0;
                playerTeam[i].turnEnd = true;
                playerTeam[i].attackedEnemy = false;
            }
            for(var i = 0; i < enemyTeam.length; i++) {
                enemyTeam[i].turnEnd = false;
            }
            console.log('enemy turn');
            doNotShow = false;
            turnNumber += 1;
        }
    }
    else {
        var counter = 0;
        for(var i = 0; i < enemyTeam.length; i++) {
            if(enemyTeam[i].movesDone == enemyTeam[i].moveCount) {
                counter += 1;
            }
        }
        console.log('enemyCounter: ' + counter);
        if(counter == enemyTeam.length) {
            for(var i = 0; i < enemyTeam.length; i++) {
                enemyTeam[i].movesDone = 0;
                enemyTeam[i].turnEnd = true;
                enemyTeam[i].attackedEnemy = false;
            }
            for(var i = 0; i < playerTeam.length; i++) {
                playerTeam[i].turnEnd = false;
            }
            console.log('player turn');
            doNotShow = false;
            turnNumber += 1;
        }
    }
}
